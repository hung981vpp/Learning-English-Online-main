<!doctype html>
<html lang="vi" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Learning English Dashboard</title>
    <link rel="shortcut icon" type="image/png" href="/assets/images/logos/favicon.png" />

    <link rel="stylesheet" href="/assets/css/styles.min.css" />
    <style>
        /* ===== Z-INDEX HIERARCHY ===== */
        /* Navbar dropdown phải cao nhất */
        .app-header {
            position: fixed !important;
            z-index: 1030 !important;
            width: 100%;
            top: 0 !important;
            margin-top: 0 !important;
        }

        .dropdown-menu {
            z-index: 1050 !important;
            position: absolute !important;
        }

        .nav-item.dropdown {
            position: relative;
            z-index: 1050;
        }

        /* Sidebar */
        .left-sidebar {
            z-index: 1020 !important;
            position: fixed !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
            top: 0 !important;
        }

        .left-sidebar>div {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* Page content - PHẢI THẤP HƠN navbar */
        .body-wrapper,
        .page-wrapper,
        #page-content,
        .container-fluid,
        .card {
            position: relative !important;
            z-index: 1 !important;
        }

        /* Sticky elements trong content */
        .sticky-top {
            z-index: 10 !important;
        }

        /* Modal và Toast */
        .modal {
            z-index: 1055 !important;
        }

        .modal-backdrop {
            z-index: 1054 !important;
        }

        #toastContainer,
        .toast-container {
            z-index: 9999 !important;
        }

        /* ===== LAYOUT FIXES ===== */
        /* Reset margin và padding */
        body,
        html {
            margin: 0 !important;
            padding: 0 !important;
        }

        .page-wrapper,
        #main-wrapper {
            margin: 0 !important;
            padding: 0 !important;
        }

        .body-wrapper {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* Brand logo */
        .brand-logo {
            margin-top: 0 !important;
            padding-top: 15px !important;
            padding-bottom: 15px !important;
        }

        /* Sidebar navigation */
        .sidebar-nav {
            margin-top: 0 !important;
        }

        /* Override first child margin */
        .page-wrapper>*:first-child {
            margin-top: 0 !important;
        }

        /* ===== CONTAINER & CONTENT ===== */
        .container-fluid {
            max-width: 100% !important;
            padding-left: 1.5rem !important;
            padding-right: 1.5rem !important;
        }

        .container-fluid.px-4 {
            padding-top: 1rem !important;
        }

        /* Card images */
        .card-img-top {
            height: 200px !important;
            object-fit: cover;
        }

        /* Responsive */
        @media (min-width: 1200px) {
            .container-fluid {
                max-width: 100% !important;
            }
        }

        /* ===== NAVBAR USER DROPDOWN ===== */
        .user-profile-img {
            position: relative;
        }

        .user-profile-img img {
            border: 2px solid #5D87FF;
            transition: transform 0.2s;
        }

        .user-profile-img img:hover {
            transform: scale(1.05);
        }

        #header-user-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #header-user-role {
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* Dropdown animation */
        .dropdown-menu-animate-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide name on small screens */
        @media (max-width: 768px) {

            #header-user-name,
            #header-user-role {
                display: none;
            }
        }

        /* ===== COURSE DETAIL SPECIFIC ===== */
        /* Review items */
        .review-item {
            padding: 1.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-item:first-child {
            padding-top: 0;
        }

        /* Star buttons */
        .star-btn {
            width: 45px;
            height: 45px;
            padding: 0;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .star-btn:hover {
            transform: scale(1.1);
        }

        .star-btn i {
            font-size: 1.3rem;
        }

        .star-btn.btn-warning {
            color: #fff !important;
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
        }

        /* Star icons */
        .ti-star,
        .ti-star-filled {
            font-size: 1.1rem;
        }

        .ti-star-filled {
            color: #ffc107;
        }

        .ti-star.text-muted {
            color: #dee2e6 !important;
        }

        /* Accordion thời gian thẳng hàng */
        .accordion-button {
            padding-right: 3rem;
        }

        .lesson-duration {
            min-width: 60px;
            text-align: right;
            flex-shrink: 0;
        }

        /* ===== NAVBAR USER INFO - FIX SPACING ===== */
        #header-user-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
            line-height: 1.2;
            margin-bottom: 0 !important;
        }

        #header-user-role {
            font-size: 0.7rem;
            color: #6c757d;
            line-height: 1;
            margin-top: 2px !important;
        }

        /* Container của tên và role */
        .ms-2.d-none.d-md-flex {
            gap: 0 !important;
            line-height: 1.2 !important;
        }

        /* Fix flex container */
        .d-flex.align-items-center>.ms-2 {
            margin-left: 8px !important;
        }
    </style>

</head>

<body>
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
        data-sidebar-position="fixed" data-header-position="fixed">

        <aside class="left-sidebar">
            <div>
                <div class="brand-logo d-flex align-items-center justify-content-between">
                    <a href="/index.html" class="text-nowrap logo-img d-flex align-items-center"
                        style="font-size: 1.5rem; color: var(--bs-primary); text-decoration: none; font-weight: 600;">
                        <i class="ti ti-graduation me-2 fs-7"></i> Learning English
                    </a>
                    <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                        <i class="ti ti-x fs-8"></i>
                    </div>
                </div>
                <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                    <ul id="sidebarnav">
                        <li class="nav-small-cap"><span class="hide-menu">Đang tải Menu...</span></li>
                    </ul>

                </nav>
            </div>
        </aside>
        <div class="body-wrapper">

            <header class="app-header">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <ul class="navbar-nav">
                        <li class="nav-item d-block d-xl-none">
                            <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse"
                                href="javascript:void(0)">
                                <i class="ti ti-menu-2"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                            <!-- User Dropdown -->
                            <li class="nav-item dropdown">
                                <a class="nav-link pe-0" href="javascript:void(0)" id="drop1" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    <div class="d-flex align-items-center">
                                        <div class="user-profile-img">
                                            <img src="/assets/images/profile/user-1.jpg" class="rounded-circle"
                                                width="35" height="35" alt="User Avatar" id="header-user-avatar"
                                                style="object-fit: cover;">
                                        </div>
                                        <div class="ms-2 d-none d-md-block">
                                            <div class="d-flex flex-column" style="line-height: 1.2;">
                                                <span class="fw-semibold" id="header-user-name"
                                                    style="font-size: 0.9rem; margin-bottom: 2px;">User</span>
                                                <small class="text-muted" id="header-user-role"
                                                    style="font-size: 0.7rem;">Student</small>
                                            </div>
                                        </div>
                                        <i class="ti ti-chevron-down ms-2"></i>
                                    </div>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                                    aria-labelledby="drop1">
                                    <div class="message-body">
                                        <!-- Profile Link -->
                                        <a href="/student/profile.html"
                                            class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-user fs-6"></i>
                                            <p class="mb-0 fs-3">Hồ sơ cá nhân</p>
                                        </a>

                                        <!-- My Courses Link -->
                                        <a href="/student/my-courses.html"
                                            class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-list-check fs-6"></i>
                                            <p class="mb-0 fs-3">Khóa học của tôi</p>
                                        </a>

                                        <!-- Settings Link (optional) -->
                                        <a href="/student/settings.html"
                                            class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-settings fs-6"></i>
                                            <p class="mb-0 fs-3">Cài đặt</p>
                                        </a>

                                        <hr class="my-2">

                                        <!-- Logout Button -->
                                        <a href="#" onclick="handleLogout(); return false;"
                                            class="btn btn-outline-danger mx-3 mt-2 d-block">
                                            <i class="ti ti-logout me-2"></i>Đăng xuất
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <div class="container-fluid" id="page-content">
                <div class="card">
                    <div class="card-body">
                        <p>Đang tải nội dung trang...</p>
                    </div>
                </div>
            </div>
            <footer class="footer text-center py-3 bg-light mt-auto">
                <p class="mb-0 fs-2">© 2025 Learning English - Developed by <a href="#" target="_blank"
                        class="pe-1 text-primary text-decoration-underline">CNTT17-10 Nhóm 6</a></p>
            </footer>
        </div>
    </div>

    <script src="/assets/libs/jquery/dist/jquery.min.js"></script>
    <script src="/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/sidebarmenu.js"></script>
    <script src="/assets/js/app.min.js"></script>
    <script src="/assets/libs/simplebar/dist/simplebar.js"></script>

    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!requireAuth()) return; // Yêu cầu đăng nhập

            const user = getCurrentUser(); // Lấy thông tin user
            if (user) {
                // Cập nhật UI (ảnh profile, tên nếu cần)
                const userAvatar = user.anhDaiDien || '/assets/images/profile/user-1.jpg'; // Dùng ảnh mặc định nếu user chưa có
                document.getElementById('header-user-avatar').src = userAvatar;
                // ===== THÊM CẬP NHẬT TÊN VÀ VAI TRÒ =====
                const userName = user.hoTen || user.email || 'User';
                const userRole = user.isAdmin ? 'Quản trị viên' : 'Học viên';

                document.getElementById('header-user-name').textContent = userName;
                document.getElementById('header-user-role').textContent = userRole;

                console.log('User info loaded:', { userName, userRole, avatar: userAvatar });
            }

            loadSidebarMenu(user);

            const pageContentUrl = getPageContentUrl();
            if (pageContentUrl) {
                await loadPageContent(pageContentUrl, 'page-content');
            } else {
                document.getElementById('page-content').innerHTML = '<div class="card"><div class="card-body"><h2>Lỗi: Không tìm thấy nội dung trang!</h2></div></div>';
            }
        });

        function getPageContentUrl() {
            const path = window.location.pathname;
            console.log("Current path for content:", path); // Debug path
            if (path.endsWith('/student/my-courses.html')) {
                return '/student/my-courses-content.html';
            }
            if (path.endsWith('/pages/courses.html')) {
                return '/pages/courses-content.html';
            }
            if (path.endsWith('/pages/course-detail.html')) {
                return '/pages/course-detail-content.html'; // File nội dung cho trang chi tiết
            }
            if (path.endsWith('/pages/lesson.html')) {
                return '/pages/lesson-content.html'; // File nội dung cho trang bài học
            }
            if (path.endsWith('/pages/quiz.html')) {
                return '/pages/quiz-content.html'; // File nội dung cho trang quiz
            }
            if (path.endsWith('/student/profile.html')) {
                return '/student/profile-content.html'; // Cần tạo file này
            }
            if (path.endsWith('/admin/dashboard.html')) {
                return '/admin/dashboard-content.html'; // Cần tạo file này
            }
            if (path.endsWith('/admin/manage-users.html')) {
                return '/admin/manage-users-content.html'; // Cần tạo file này
            }
            if (path.endsWith('/admin/manage-courses.html')) {
                return '/admin/manage-courses-content.html'; // Cần tạo file này
            }
            // Thêm các trang khác

            console.warn("Không xác định được nội dung cho path:", path);
            return null;
        }

        async function loadPageContent(pageUrl, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) { console.error(`Target element #${targetElementId} not found.`); return; }

            try {
                targetElement.innerHTML = '<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'; // Loader
                const response = await fetch(pageUrl);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`); }
                const html = await response.text();
                targetElement.innerHTML = html;

                // Thực thi script trong nội dung được load
                const scripts = targetElement.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                // Khởi tạo lại các plugin Bootstrap nếu cần (ví dụ: tooltips)
                if (typeof bootstrap !== 'undefined' && typeof bootstrap.Tooltip === 'function') {
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                }


            } catch (error) {
                console.error(`Error loading page content ${pageUrl}:`, error);
                targetElement.innerHTML = `<div class="alert alert-danger mx-3">Lỗi tải nội dung trang: ${error.message}</div>`;
            }
        }

        function loadSidebarMenu(user) {
            const menuElement = document.getElementById('sidebarnav');
            if (!menuElement) return;

            let menuHtml = '';
            const currentPath = window.location.pathname;

            // Helper function để check active
            const isActive = (path) => currentPath.includes(path);
            const activeClass = (path) => isActive(path) ? 'active' : '';

            // Menu cho Student
            if (user && !user.isAdmin) {
                menuHtml += `
            <li class="nav-small-cap">
                <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                <span class="hide-menu">Trang chủ</span>
            </li>
            <li class="sidebar-item ${activeClass('/student/dashboard')}">
                <a class="sidebar-link" href="/student/dashboard.html" aria-expanded="false">
                    <span><i class="ti ti-layout-dashboard"></i></span>
                    <span class="hide-menu">Dashboard</span>
                </a>
            </li>
            <li class="nav-small-cap">
                <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                <span class="hide-menu">Học tập</span>
            </li>
            <li class="sidebar-item ${activeClass('/student/my-courses')}">
                <a class="sidebar-link" href="/student/my-courses.html" aria-expanded="false">
                    <span><i class="ti ti-book"></i></span>
                    <span class="hide-menu">Khóa học của tôi</span>
                </a>
            </li>
            <li class="sidebar-item ${activeClass('/student/courses')}">
                <a class="sidebar-link" href="/pages/courses.html" aria-expanded="false">
                    <span><i class="ti ti-search"></i></span>
                    <span class="hide-menu">Tìm khóa học</span>
                </a>
            </li>
            <li class="sidebar-item ${isActive('/pages/quiz') ? 'active' : ''}">
                  <a class="sidebar-link" href="/pages/quiz.html" aria-expanded="false">
                    <span><i class="ti ti-file-pencil"></i></span><span class="hide-menu">Bài kiểm tra</span>
                  </a>
                </li>
            <li class="nav-small-cap">
                <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                <span class="hide-menu">Tài khoản</span>
            </li>
            <li class="sidebar-item ${activeClass('/student/profile')}">
                <a class="sidebar-link" href="/student/profile.html" aria-expanded="false">
                    <span><i class="ti ti-user"></i></span>
                    <span class="hide-menu">Hồ sơ cá nhân</span>
                </a>
            </li>
        `;
            }

            // Menu cho Admin
            else if (user && user.isAdmin) {
                menuHtml += `
            <li class="nav-small-cap">
                <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                <span class="hide-menu">Quản trị</span>
            </li>
            <li class="sidebar-item ${activeClass('/admin/dashboard')}">
                <a class="sidebar-link" href="/admin/dashboard.html" aria-expanded="false">
                    <span><i class="ti ti-layout-dashboard"></i></span>
                    <span class="hide-menu">Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item ${activeClass('/admin/manage-users')}">
                <a class="sidebar-link" href="/admin/manage-users.html" aria-expanded="false">
                    <span><i class="ti ti-users"></i></span>
                    <span class="hide-menu">Quản lý người dùng</span>
                </a>
            </li>
            <li class="sidebar-item ${activeClass('/admin/manage-courses')}">
                <a class="sidebar-link" href="/admin/manage-courses.html" aria-expanded="false">
                    <span><i class="ti ti-book-2"></i></span>
                    <span class="hide-menu">Quản lý khóa học</span>
                </a>
            </li>
        `;
            }

            menuElement.innerHTML = menuHtml;
            // Kích hoạt lại JS của sidebar menu sau khi cập nhật HTML
            if (typeof $('#sidebarnav').metisMenu === 'function') {
                //$('#sidebarnav').metisMenu('dispose'); // Hủy instance cũ nếu có
                //$('#sidebarnav').metisMenu(); // Khởi tạo lại
                // Hoặc gọi hàm khởi tạo từ template nếu có sẵn
            } else if (typeof sidebarmenu === 'function') {
                // Thử gọi hàm global nếu nó tồn tại
                // sidebarmenu(jQuery); // Giả sử nó cần jQuery
            }
        }

        // Hàm logout mới (đảm bảo hoạt động từ mọi nơi)
        function handleLogout() {
            logout(); // Gọi hàm logout gốc từ auth.js để xóa token
            window.location.href = '/login.html'; // Chuyển hướng về trang đăng nhập
        }

    </script>

</body>

</html>